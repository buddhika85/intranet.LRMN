@model IEnumerable<Persistance.DomainModel.ApplicationUser>
@{
    ViewBag.Title = "ManageContacts";
}

<h2>Manage Contacts</h2>
<table id="contactsTbl" class="table table-bordered table-responsive"></table>

@section scripts {

    <script type="text/javascript">

        $(document).ready(function () {            
            $.ajax({
                url: '/API/ManageContactsAPI',
                method: 'GET',
                data: null,
                cache: false,
                async: false,
                success: function (result) {                    
                    drawContactsTable(result);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {                    
                    bootbox.alert({
                        title: "<span class='text-danger'><strong>Error</strong></span>",
                        message: "Unabled to retrieve contacts" + " - Please contact IT support"
                    });                                   
                }
            });

        });

        // draw data table
        function drawContactsTable(contacts) {
            $("#contactsTbl").dataTable(
                {
                    "data": contacts,
                    "aoColumns": [
                            { "mData": "UserIdGenerated", "sTitle": "ID", "bVisible": false },
                            { "mData": "UserId", "sTitle": "UserId", "bVisible": false },
                            { "mData": "Email", "sTitle": "Username", "bVisible": true },
                            { "mData": "FirstName", "sTitle": "First Name", "bVisible": true },
                            { "mData": "LastName", "sTitle": "Last Name", "bVisible": true },
                            { "mData": "PhoneNumber", "sTitle": "Phone", "bVisible": true },
                            { "mData": "JoinDate", "sTitle": "Joined", "bVisible": false },
                            { "mData": "ContractEndDate", "sTitle": "Contract Ends", "bVisible": false },
                            {
                                "mData": "UserActive", "sTitle": "Activated?", "bVisible": true, "sClass": "right", "mRender": function (data, type, row) {
                                    if (data == true) {
                                        return '<div style="background-color:lightgreen; text-align:center">active</div> ';
                                    }
                                    else {
                                        return '<div style="background-color:darkorange; text-align:center">INACTIVE</div> ';
                                    }
                                },
                                "aTargets": [0]
                            },
                            {
                                "mData": "UserLocked", "sTitle": "Locked", "bVisible": true, "sClass": "right", "mRender": function (data, type, row) {
                                    if (data == false) {
                                        return "<button class='lockContact' class='btn-sm btn-danger' style='width:75%;background-color: #ff4d4d; 'data-contact-id=" + row.UserId + "> Lock </button>";
                                    }
                                    else {
                                        return "<button class='unlockContact' class='btn-sm btn-info' style='width:75%;background-color: #668cff; 'data-contact-id=" + row.UserId + ">Unlock</button>";
                                    }
                                },
                                "aTargets": [0]
                            },
                            { "mData": "RoleName", "sTitle": "Role", "bVisible": true },
                            { "mData": "ContactType", "sTitle": "Contact Type", "bVisible": true },
                            { "mData": "AccessFailedCount", "sTitle": "Access Failed Count", "bVisible": false },
                            {
                                "sTitle": "Edit", "mRender": function (data, type, row) {
                                    return "<button class='editContact' data-contact-id=" + row.UserId + "><span class='glyphicon glyphicon-edit'></span></button>";
                                },
                                "aTargets": [0]
                            },
                    ],
                    "bDestroy": true,
                    "aLengthMenu": [[15, 50, 100, 200, 500, 700, 1000, -1], [15, 50, 100, 200, 500, 700, 1000, "All"]],
                    "iDisplayLength": -1
                }
            );
        }

        $("#contactsTbl").on("click", ".editContact", function () {
            var button = $(this);
            alert(button.attr('data-contact-id'));
        });

        $("#contactsTbl").on("click", ".lockContact", function () {
            var button = $(this);
            alert(button.attr('data-contact-id'));
        });

        $("#contactsTbl").on("click", ".unlockContact", function () {
            var button = $(this);
            alert(button.attr('data-contact-id'));
        });
    </script>
}

